<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manajemen User | Donuts</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üç©</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .sidebar-item:hover { background-color: #fff1f2; color: #e11d48; }
        .active-nav { background-color: #ffe4e6; color: #e11d48; font-weight: 700; }
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow-x: hidden; overflow-y: hidden !important; }
    </style>
</head>
<body class="bg-slate-50 flex overflow-hidden h-screen text-slate-800">

    <aside class="w-64 bg-white border-r border-slate-200 flex flex-col h-full z-20">
        <div class="p-6">
            <h1 class="text-2xl font-black italic text-rose-500 tracking-tighter">Donuts.</h1>
        </div>
        <nav class="flex-1 px-4 space-y-1">
            <a href="index.html" class="flex items-center gap-3 px-3 py-3 rounded-xl sidebar-item text-slate-600 font-medium">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i><span class="text-sm">Dashboard</span>
            </a>
            <div class="pt-4 pb-2 px-2 text-[10px] font-black text-slate-400 uppercase tracking-widest text-rose-500">Manajemen</div>
            <a href="user.html" class="flex items-center gap-3 px-3 py-3 rounded-xl active-nav">
                <i data-lucide="users" class="w-5 h-5"></i><span class="text-sm">Daftar Pengguna</span>
            </a>
            <a href="pengaturan.html" class="flex items-center gap-3 px-3 py-3 rounded-xl sidebar-item text-slate-600 font-medium">
                <i data-lucide="settings" class="w-5 h-5"></i><span class="text-sm">Pengaturan</span>
            </a>
        </nav>
    </aside>

    <main class="flex-1 overflow-y-auto p-8">
        <header class="mb-10 flex justify-between items-end">
            <div>
                <h2 class="text-3xl font-black text-slate-900 tracking-tight">Manajemen User</h2>
                <p class="text-slate-500 font-medium">Kelola hak akses admin dan kasir toko.</p>
            </div>
            <button onclick="toggleModal()" class="bg-rose-500 hover:bg-rose-600 text-white px-6 py-3 rounded-2xl font-bold text-sm flex items-center gap-2 transition-all shadow-lg shadow-rose-100">
                <i data-lucide="user-plus" class="w-4 h-4"></i> Tambah User Baru
            </button>
        </header>

        <div class="bg-white rounded-[2.5rem] border border-slate-100 shadow-sm overflow-hidden">
            <table class="w-full text-left border-collapse">
                <thead class="bg-slate-50 text-[10px] font-black text-slate-400 uppercase tracking-widest">
                    <tr>
                        <th class="p-6">User</th>
                        <th class="p-6">Role</th>
                        <th class="p-6 text-right">Aksi</th>
                    </tr>
                </thead>
                <tbody id="user-list" class="divide-y divide-slate-50"></tbody>
            </table>
        </div>
    </main>

    <div id="modal-user" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-slate-900 opacity-50"></div>
        <div class="modal-container bg-white w-full max-w-md mx-auto rounded-[2.5rem] shadow-2xl z-50 overflow-y-auto">
            <div class="p-8">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-black italic">Daftarkan User</h3>
                    <button onclick="toggleModal()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x"></i></button>
                </div>
                
                <form id="add-user-form" class="space-y-4">
                    <div>
                        <label class="block text-[10px] font-black text-slate-400 uppercase mb-2 ml-1">Email Karyawan</label>
                        <input type="email" id="new-email" required class="w-full bg-slate-50 border-0 rounded-2xl px-5 py-3 focus:ring-2 focus:ring-rose-500 font-semibold outline-none" placeholder="email@donuts.com">
                    </div>
                    <div>
                        <label class="block text-[10px] font-black text-slate-400 uppercase mb-2 ml-1">Password Awal</label>
                        <input type="password" id="new-password" required class="w-full bg-slate-50 border-0 rounded-2xl px-5 py-3 focus:ring-2 focus:ring-rose-500 font-semibold outline-none" placeholder="Min. 6 karakter">
                    </div>
                    <div>
                        <label class="block text-[10px] font-black text-slate-400 uppercase mb-2 ml-1">Role Jabatan</label>
                        <select id="new-role" class="w-full bg-slate-50 border-0 rounded-2xl px-5 py-3 focus:ring-2 focus:ring-rose-500 font-bold outline-none">
                            <option value="kasir">KASIR</option>
                            <option value="admin">ADMIN</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-black text-sm hover:bg-rose-500 transition-all mt-4">
                        KONFIRMASI PENDAFTARAN
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        const SB_URL = "https://bkkpkfvcssdmgnncrrhu.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJra3BrZnZjc3NkbWdubmNycmh1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3OTQ4OTIsImV4cCI6MjA4NjM3MDg5Mn0.VeE2IZhQmTyKMMQI4Ukh0nt6YHR2zVs_nUnjtPt-GPQ"; // Gunakan Key Anda
        const _supabase = supabase.createClient(SB_URL, SB_KEY);

        // --- MODAL TOGGLE ---
        function toggleModal() {
            const modal = document.getElementById('modal-user');
            modal.classList.toggle('opacity-0');
            modal.classList.toggle('pointer-events-none');
            document.body.classList.toggle('modal-active');
        }

        // --- ADD USER MANUAL ---
        document.getElementById('add-user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('new-email').value;
            const password = document.getElementById('new-password').value;
            const role = document.getElementById('new-role').value;

            // 1. Daftarkan ke Supabase Auth
            const { data: authData, error: authError } = await _supabase.auth.signUp({
                email: email,
                password: password,
            });

            if (authError) {
                alert("Error Auth: " + authError.message);
                return;
            }

            // 2. Insert ke Tabel Profil
            if (authData.user) {
                const { error: profileError } = await _supabase.from('profil').insert([
                    { id: authData.user.id, email: email, role: role }
                ]);

                if (profileError) {
                    alert("Auth Berhasil, tapi Profil gagal: " + profileError.message);
                } else {
                    alert("User " + email + " berhasil didaftarkan!");
                    toggleModal();
                    fetchUsers();
                }
            }
        });

        // --- FETCH & UPDATE DATA (Sama seperti sebelumnya) ---
        async function fetchUsers() {
            const { data } = await _supabase.from('profil').select('*').order('created_at', { ascending: false });
            const container = document.getElementById('user-list');
            container.innerHTML = data.map(u => `
                <tr class="hover:bg-slate-50/50 transition-all">
                    <td class="p-6">
                        <p class="font-bold text-slate-800">${u.email}</p>
                    </td>
                    <td class="p-6 font-black text-xs ${u.role === 'admin' ? 'text-rose-500' : 'text-blue-500'} uppercase">
                        ${u.role}
                    </td>
                    <td class="p-6 text-right">
                        <button onclick="deleteUser('${u.id}')" class="text-slate-300 hover:text-rose-500 transition-all"><i data-lucide="trash-2"></i></button>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        window.onload = fetchUsers;
    </script>
</body>
</html>
