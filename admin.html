<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Kasir - Donuts</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-slate-100 p-8">
    <div class="max-w-6xl mx-auto">
        <header class="flex justify-between items-center mb-10">
            <div>
                <h1 class="text-3xl font-black text-slate-800 italic">PESANAN MASUK</h1>
                <p class="text-slate-500 font-bold">Pantau & Proses Orderan Real-time</p>
            </div>
            <div id="connection-status" class="bg-emerald-100 text-emerald-600 px-4 py-2 rounded-full text-xs font-bold flex items-center gap-2">
                <span class="w-2 h-2 bg-emerald-500 rounded-full animate-ping"></span> Realtime Connected
            </div>
        </header>

        <div id="admin-orders-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            </div>
    </div>

    <script>
        const SB_URL = "https://bkkpkfvcssdmgnncrrhu.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."; // Gunakan Service Role Key Anda
        const _supabase = supabase.createClient(SB_URL, SB_KEY);

        async function fetchOrders() {
            const { data } = await _supabase
                .from('pesanan_pelanggan')
                .select('*')
                .order('created_at', { ascending: false });
            renderOrders(data);
        }

        function renderOrders(orders) {
            const container = document.getElementById('admin-orders-container');
            container.innerHTML = orders.map(o => `
                <div class="bg-white rounded-[2rem] p-6 shadow-sm border-2 ${o.status === 'menunggu' ? 'border-rose-500 animate-pulse' : 'border-transparent'}">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <span class="bg-slate-100 px-3 py-1 rounded-full text-[10px] font-black uppercase text-slate-500">${o.tipe_order}</span>
                            <h3 class="text-xl font-black mt-1">${o.nama_pelanggan}</h3>
                            <p class="text-xs font-bold text-slate-400">Meja: ${o.nomor_meja}</p>
                        </div>
                        <p class="text-sm font-black text-rose-500 italic">Rp ${o.total_harga.toLocaleString()}</p>
                    </div>

                    <div class="space-y-2 mb-6 border-y border-slate-50 py-4">
                        ${o.items.map(i => `<p class="text-xs font-bold text-slate-600">${i.qty}x ${i.nama}</p>`).join('')}
                    </div>

                    ${o.bukti_bayar_url ? `
                        <a href="${o.bukti_bayar_url}" target="_blank" class="block w-full text-center bg-blue-50 text-blue-600 py-2 rounded-xl text-[10px] font-black mb-4 hover:bg-blue-100 transition-all">
                            LIHAT BUKTI BAYAR ðŸ“¸
                        </a>
                    ` : ''}

                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="updateStatus(${o.id}, 'proses')" class="bg-amber-500 text-white py-3 rounded-xl text-[10px] font-black">PROSES</button>
                        <button onclick="updateStatus(${o.id}, 'siap')" class="bg-emerald-500 text-white py-3 rounded-xl text-[10px] font-black">SIAP SAJI</button>
                        <button onclick="updateStatus(${o.id}, 'selesai')" class="bg-slate-800 text-white py-3 rounded-xl text-[10px] font-black col-span-2">SELESAI & ARSIP</button>
                    </div>
                </div>
            `).join('');
        }

        async function updateStatus(id, newStatus) {
            const { error } = await _supabase
                .from('pesanan_pelanggan')
                .update({ status: newStatus })
                .eq('id', id);
            
            if(!error) fetchOrders();
        }

        // Realtime Subscription
        _supabase.channel('custom-all-channel')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'pesanan_pelanggan' }, () => {
            fetchOrders();
            new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3').play(); // Bunyi notif
        }).subscribe();

        fetchOrders();
    </script>
</body>
</html>
